function addRangeAsTableToWorksheet(range:ExcelScript.Range,worksheet:ExcelScript.Worksheet,hasHeaders:boolean){worksheet.getCell(0,0).copyFrom(range);return worksheet.addTable(worksheet.getRangeByIndexes(0,0,range.getRowCount(),range.getColumnCount()),hasHeaders)}function addWorksheet(worksheetName:string){worksheetName=worksheetName.slice(0,30);if(workbook.getWorksheet(worksheetName)){workbook.getWorksheet(worksheetName).delete()}return workbook.addWorksheet(worksheetName)}function getActiveWorksheetDataRange(){let activeWorksheet=workbook.getActiveWorksheet();let firstTable=activeWorksheet.getTables()[0];if(typeof firstTable==='undefined'){try{return activeWorksheet.getUsedRange();}catch(error){console.log('Could retrieve the used range.');return getUsedRangeInCompatibilityMode(activeWorksheet,10)}}return firstTable.getRange()}function getFirstColumnValuesInRange(range:ExcelScript.Range){return range.getColumn(0).getTexts().map(columnValue=>columnValue[0])}function getLastColumnIndexInWorksheet(worksheet:ExcelScript.Worksheet,threshold:number){let column=worksheet.getCell(0,0).getEntireColumn();let lastColumnWithValues:ExcelScript.Range;while(threshold>0){if(getNonEmptyCellCountInRange(column)===0){threshold=threshold-1}else{lastColumnWithValues=column}column=column.getColumnsAfter()}return lastColumnWithValues.getColumnIndex()}function getLastRowIndexInWorksheet(worksheet:ExcelScript.Worksheet,threshold:number){let row=worksheet.getCell(0,0).getEntireRow();let lastRowWithValues:ExcelScript.Range;while(threshold>0){if(getNonEmptyCellCountInRange(row)===0){threshold=threshold-1}else{lastRowWithValues=row}row=row.getRowsBelow()}return lastRowWithValues.getRowIndex()}function getNonEmptyCellCountInRange(range:ExcelScript.Range){return range.getTexts().filter(cellValue=>cellValue[0].trim().length).length}function getRangeOffsetByCellValue(range:ExcelScript.Range,cellValue:string,removeEmptyRows:boolean){const cell=range.find(cellValue,{completeMatch:true,matchCase:true});if(typeof cell==='undefined'){throw new Error(`Could not retrieve the cell with value ${cellValue}.`)} if(removeEmptyRows){return removeEmptyRowsFromRange(range.getOffsetRange(cell.getRowIndex(),cell.getColumnIndex()).getResizedRange(cell.getRowIndex(),-cell.getColumnIndex()))}else{return range.getOffsetRange(cell.getRowIndex(),cell.getColumnIndex()).getResizedRange(cell.getRowIndex(),-cell.getColumnIndex())}}function getTableColumnValuesByColumnName(table:ExcelScript.Table,columnName:string){const column=table.getColumnByName(columnName);if(typeof column==='undefined'){throw new Error(`Could not retrieve ${columnName} column.`)}return column.getRangeBetweenHeaderAndTotal().getTexts().map(columnValue=>columnValue[0])}function getUsedRangeInCompatibilityMode(worksheet:ExcelScript.Worksheet,threshold:number){return getWorksheetRange(worksheet,getLastRowIndexInWorksheet(worksheet,threshold)+1,getLastColumnIndexInWorksheet(worksheet,threshold)+1)}function getWorksheetRange(worksheet:ExcelScript.Worksheet,rowCount:number,columnCount:number){return worksheet.getRangeByIndexes(0,0,rowCount,columnCount)}function removeEmptyRowsFromRange(range:ExcelScript.Range){let row=range.getLastRow();let emptyRows:ExcelScript.Range[]=new Array();while(row){if(getNonEmptyCellCountInRange(row)===0){emptyRows.push(row)}if(row.getRowIndex()===0){break}row=row.getRowsAbove()}for(let emptyRow of emptyRows){emptyRow.delete(ExcelScript.DeleteShiftDirection.up)}return range}
